<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server Test</title>
  </head>
  <body>
    <div id="main">
      <div id="searchbar">
        <form id="searchForm" action="/search" method="get">
          <input type="text" id="input" name="input" />
          <button type="button" onclick="submitSearch()">Search</button>
        </form>
      </div>

      <button id="writeButton" onClick="location.href='/api/post/write'">
        새글쓰기
      </button>

      <table width="1000" border="1" id="Table">
        <thead>
          <tr>
            <th>Category</th>
            <th>ID</th>
            <th>Title</th>
            <th>UserId</th>
            <th>CreatedAt</th>
            <th>UpdatedAt</th>
          </tr>
        </thead>
        <tbody id="TableBody">
          <!-- Table Rows -->
        </tbody>
      </table>

      <div id="pagination">
        <!-- Pagination Results -->
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const url = new URL(window.location.href);
        const page = url.pathname.split("/")[2] || 1;
        fetchPost(page);

        const searchButton = document.querySelector("#searchForm button");
        searchButton.addEventListener("click", submitSearch);
      });

      // 게시글
      function fetchPost(page) {
        fetch(`/api/post/${page}`)
          .then((response) => response.json())
          .then((data) => {
            const tableBody = document.getElementById("TableBody");
            tableBody.innerHTML = "";

            data.currPageRows.forEach((post) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${post.category}</td>
                <td>${post.id}</td>
                <td><a href="/api/post/view/${post.id}">${post.title}</a></td>
                <td>${post.userId}</td>
                <td>${post.createdAt}</td>
                <td>${post.updatedAt}</td>
            `;
              tableBody.appendChild(row);
            });
            renderPaginationLinks(data, "fetchPost");
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
      }

      // 검색 기능
      function submitSearch() {
        const input = document.getElementById("input").value;
        fetchSearch(input);
      }

      function fetchSearch(input) {
        fetch(`/api/search/${input}`)
          .then((response) => response.json())
          .then((data) => {
            const tableBody = document.getElementById("TableBody");
            tableBody.innerHTML = "";

            data.currPageRows.forEach((post) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${post.category}</td>
                <td>${post.id}</td>
                <td><a href="/api/post/view/${post.id}">${post.title}</a></td>
                <td>${post.userId}</td>
                <td>${post.createdAt}</td>
                <td>${post.updatedAt}</td>
            `;
              tableBody.appendChild(row);
            });
            renderPaginationLinks(data, "fetchSearch");
          })
          .catch((error) => {
            console.error("Error fetching search data:", error);
          });
      }

      // 페이징
      function renderPaginationLinks(data, fetchFunction) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const maxButtonsToShow = 10;
        const startPage = Math.max(
          1,
          data.page - Math.floor(maxButtonsToShow / 2)
        );
        const endPage = Math.min(
          data.totalPages,
          startPage + maxButtonsToShow - 1
        );

        // 이전
        if (data.page > 1) {
          const prevSpan = document.createElement("span");
          prevSpan.innerHTML = `<a id="searchLink" onclick="${fetchFunction}(${
            data.page - 1
          })">Previous</a>`;
          paginationDiv.appendChild(prevSpan);
        }

        // 숫자
        for (let num = startPage; num <= endPage; num++) {
          const pageSpan = document.createElement("span");
          pageSpan.innerHTML = `<a id="searchLink" onclick="${fetchFunction}('${num}')">${num}</a>`;
          paginationDiv.appendChild(pageSpan);
        }

        // 다음
        if (data.page < data.totalPages) {
          const nextSpan = document.createElement("span");
          nextSpan.innerHTML = `<a id="searchLink" onclick="${fetchFunction}('${
            data.page + 1
          }')">Next</a>`;
          paginationDiv.appendChild(nextSpan);
        }
      }
    </script>
  </body>
</html>
